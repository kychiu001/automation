---
- import_playbook: ../local-ansible/gen-gpgkey-ubuntu.yaml
  vars:
    hosts: localhost
    gpg_generator_user: jenkins
    gpg_home: "/var/lib/jenkins"

- name: Build, tag and push image to DockerHub
  hosts: localhost
  connection: local
  gather_facts: false
  become_user: jenkins
  vars:
    jenkins_path: /var/lib/jenkins/workspace/
    pipeline_name: pipeline1

  tasks:
  - name: Get Docker credentials from environment variables
    set_fact:
      DOCKER_USER: "{{ lookup('env', 'DOCKER_USER') }}"
      DOCKER_PASSWORD: "{{ lookup('env', 'DOCKER_PASSWORD') }}"
    no_log: true

  - name: Verify Docker credentials are available
    fail:
      msg: "Docker credentials not found in environment variables. Please set DOCKER_USER and DOCKER_PASSWORD."
    when: DOCKER_USER == '' or DOCKER_PASSWORD == ''

  - name: Login to DockerHub
    shell: "echo {{DOCKER_PASSWORD}} | docker login -u {{DOCKER_USER}} --password-stdin"
    no_log: true

  - name: Stop running containers
    command: docker compose -f dockerhub.yml down
    args:
      chdir: /opt/StaycationX

  - name: Get all Docker images
    command: docker images --format "{{ '{{.Repository}}:{{.Tag}}' }}"
    register: docker_images

  - name: Set images to exclude
    set_fact:
      exclude_images:
      - "node:16.20.2-alpine"
      - "python:3.12"
      - "nginx:latest"
      - "mongo:latest"

  - name: Find images to remove
    set_fact:
      images_to_remove: "{{ docker_images.stdout_lines | difference(exclude_images) }}"

  - name: Remove existing Docker images excluding specific ones
    community.docker.docker_image:
      name: "{{ item }}"
      state: absent
    loop: "{{ images_to_remove }}"
    when: item is defined

  - name: Build StaycationX Image
    community.docker.docker_image:
      name: ict381_staycation
      build:
        path: "{{jenkins_path}}/{{pipeline_name}}/StaycationX/"
      source: build

  - name: Tag and Push to repo for StaycationX
    community.docker.docker_image:
      name: ict381_staycation
      repository: "{{DOCKER_USER}}/ict381_staycation"
      push: true
      source: local

  - name: Build MongoDB Image
    community.docker.docker_image:
      name: ict381_mongo
      build:
        path: "{{jenkins_path}}/{{pipeline_name}}/StaycationX/"
        dockerfile: DockerfileMongo
      source: build

  - name: Tag and Push to repo for MongoDB
    community.docker.docker_image:
      name: ict381_mongo
      repository: "{{DOCKER_USER}}/ict381_mongo"
      push: true
      source: local

  - name: Build myReactApp Image
    community.docker.docker_image:
      name: ict381_myreactapp
      build:
        path: "{{jenkins_path}}/{{pipeline_name}}/myReactApp/"
        dockerfile: DockerfilemyReactApp
      source: build

  - name: Tag and Push to repo for myReactApp
    community.docker.docker_image:
      name: ict381_myreactapp
      repository: "{{DOCKER_USER}}/ict381_myreactapp"
      push: true
      source: local

  - name: Prune system to conserve space
    community.docker.docker_prune:
      images: true
      builder_cache: true
      volumes: true
      networks: true
      containers: true
